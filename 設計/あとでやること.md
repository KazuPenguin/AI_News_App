# あとでやること

CDK デプロイ後や開発中に手動対応が必要な作業をまとめる。

---

## 本番環境への移行時（CDK 設定変更）

- [ ] **`database-stack.ts`**: `removalPolicy` を `cdk.RemovalPolicy.RETAIN` に変更（DB 削除防止）
- [ ] **`database-stack.ts`**: `multiAz` を `true` に変更（高可用性）
- [ ] **`database-stack.ts`**: `deletionProtection` を `true` に変更
- [ ] **`database-stack.ts`**: インスタンスタイプを `db.t4g.small` 以上に変更
- [ ] **`network-stack.ts`**: `natGateways` を `2` に変更（AZ 冗長化）
- [ ] **`api-stack.ts`**: CORS `allowOrigins` を `ALL_ORIGINS` から本番ドメインに制限
- [ ] **`api-stack.ts`**: `dataTraceEnabled` が `false` であることを確認（リクエストボディのログ無効化）
- [ ] **`auth-stack.ts`**: メール送信を Cognito デフォルトから **SES** に切り替え（送信制限の緩和）
- [ ] **`auth-stack.ts`**: `callbackUrls` / `logoutUrls` を正式なカスタムスキームに更新（`myapp://` → 正式値）

---

## NetworkStack 関連

- [ ] **VPC Endpoints の追加検討** — NAT Gateway 経由のコスト削減
  - S3 Gateway Endpoint（S3 アクセスは NAT 不要にできる）
  - Secrets Manager Interface Endpoint（Lambda → Secrets Manager を VPC 内で完結）
  - CloudWatch Logs Interface Endpoint

---

## DatabaseStack 関連

- [ ] **pgvector 拡張の有効化** — RDS デプロイ後に実行
  ```sql
  psql -h <RDS_ENDPOINT> -U postgres -d ai_research
  CREATE EXTENSION IF NOT EXISTS vector;
  ```
  - 踏み台インスタンス or AWS CloudShell + SSM Session Manager 経由で接続
  - 確認: `SELECT * FROM pg_extension WHERE extname = 'vector';`
  - 将来的にはカスタムリソース (Lambda) で自動化を検討

- [ ] **初期スキーマ投入** — `database_schema.md` のテーブル定義を反映
  - Alembic マイグレーション or 初回実行スクリプトで投入
  - `alembic revision --autogenerate -m "initial"` → `alembic upgrade head`

- [ ] **アンカーデータの初期投入** — `pgvector.md` §3 の 6 カテゴリ分
  - Embedding を生成して `anchors` テーブルに INSERT

---

## StorageStack 関連

- [ ] **CloudFront にカスタムドメイン設定** — `cdn.example.com` 等（ACM 証明書の取得含む）
- [ ] **WAF の追加検討** — CloudFront ディストリビューションへの Web ACL 設定

---

## AuthStack 関連

- [ ] **Google OAuth クライアント ID / Secret の取得** → Secrets Manager に登録
- [ ] **Apple Sign In の Service ID / Key の取得** → Secrets Manager に登録
- [ ] **Google ソーシャルログインの有効化** — クレデンシャル取得後に `auth-stack.ts` のコメントアウトを解除
  - `UserPoolIdentityProviderGoogle` のコメントアウト解除
  - `clientId` を Google Cloud Console の値に設定
  - `clientSecretValue` を Secrets Manager ARN に設定
  - `supportedIdentityProviders` に `GOOGLE` を追加
- [ ] **Apple ソーシャルログインの有効化** — クレデンシャル取得後に `auth-stack.ts` のコメントアウトを解除
  - `UserPoolIdentityProviderApple` のコメントアウト解除
  - `clientId`, `teamId`, `keyId`, `privateKey` を設定
  - `supportedIdentityProviders` に `APPLE` を追加

---

## BatchStack 関連

- [ ] **OpenAI API Key** を Secrets Manager に登録
  - `aws secretsmanager create-secret --name ai-research/openai-api-key --secret-string '{"api_key":"sk-xxx"}'`
- [ ] **Google AI Studio Key** を Secrets Manager に登録
  - `aws secretsmanager create-secret --name ai-research/gemini-api-key --secret-string '{"api_key":"xxx"}'`
- [ ] **Lambda パッケージングの検討** — 依存ライブラリが多い場合は Docker コンテナイメージに切り替え
  - 現在は `Code.fromAsset` (ZIP) → `DockerImageFunction` への移行検討
- [ ] **DLQ (Dead Letter Queue) の追加** — バッチ失敗時の通知・リトライ用 SQS キュー
- [ ] **CloudWatch Alarm の設定** — バッチ Lambda のエラー率・実行時間の監視

---

## ApiStack 関連

- [ ] **API Gateway にカスタムドメイン設定** — `api.example.com`（Route 53 + ACM 証明書）
- [ ] **WAF の追加** — API Gateway への Web ACL（レートベースルール、SQL インジェクション対策）
- [ ] **API キーの追加検討** — Usage Plan でクライアントアプリ単位のスロットリング

---

## CI/CD 関連 (GitHub Actions)

### AWS 連携設定

### Phase 1: 足場固め (Frontend CI)
- [ ] **Frontend**: `package.json` に `lint` (ESLint/Prettier) スクリプトを追加
- [ ] **Frontend**: `package.json` に `test` (Jest/Vitest) スクリプトを追加
- [ ] **Frontend**: `package.json` に `type-check` (tsc) スクリプトを追加
- [ ] **Frontend**: `.github/workflows/frontend.yml` で上記スクリプトを実行するように修正

### Phase 2: デプロイ自動化の拡充
- [ ] **Frontend (Web)**: `infra` に Hosting 用スタック (S3 + CloudFront) を追加
- [ ] **Frontend (Web)**: GitHub Actions に Build & Deploy ジョブを追加
- [ ] **Frontend (Mobile)**: EAS (Expo Application Services) プロジェクトの初期化と CI 連携

### Phase 3: 品質の向上
- [ ] **E2E テスト**: Playwright 等を用いた統合テストの導入
- [ ] **環境分離**: Staging 環境の構築と、ブランチベースの自動デプロイフローの整備
- [ ] **監視/アラート**: 異常検知時の通知設定

---

## デプロイ後の検証
- [ ] pgvector 拡張の有効化確認 (`SELECT * FROM pg_extension;`)
- [ ] EventBridge ルールの手動テスト実行
- [ ] Cognito テストユーザーでログインフロー確認
- [ ] API エンドポイントの疎通確認（`/health` で 200 応答）
- [ ] CloudFront 経由で S3 の図表が取得できることを確認
- [ ] バッチ Lambda の手動実行テスト（`aws lambda invoke`）

